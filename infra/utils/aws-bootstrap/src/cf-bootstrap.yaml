# CloudFormation Bootstrap for Terraform
AWSTemplateFormatVersion: "2010-09-09"

Resources:
  # Terraform state bucket
  TerraformBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName:
        Fn::Sub: "${AWS::StackName}-terraform"
      LoggingConfiguration:
        DestinationBucketName:
          Ref: TerraformLogBucket
      VersioningConfiguration:
        Status: "Enabled"
      LifecycleConfiguration:
        Rules:
          - Id: "ExpirationRule"
            Status: "Enabled"
            NoncurrentVersionExpirationInDays: 90

  # Cheap DynamoDB Table for Terraform locking
  TerraformDynamoDBTable:
    Type: "AWS::DynamoDB::Table"
    Properties:
      TableName:
        Fn::Sub: "${AWS::StackName}-terraform"
      AttributeDefinitions:
        - AttributeName: "LockID"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "LockID"
          KeyType: "HASH"
      # Underprovision - this makes it cheap
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

  # Terraform State Bucket Policy
  TerraformBucketPolicy:
    Type: "AWS::S3::BucketPolicy"
    Properties:
      Bucket:
        Ref: TerraformBucket
      PolicyDocument:
        Statement:
          # Only MFA-ed users can delete
          - Action: "s3:Delete*"
            Effect: "Deny"
            Principal: "*"
            Resource:
              Fn::Sub: "arn:aws:s3:::${TerraformBucket}/*"
            Condition:
              BoolIfExists:
                aws:MultiFactorAuthPresent: false

  # S3 Access Log Bucket
  TerraformLogBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName:
        Fn::Sub: "${AWS::StackName}-terraform-logs"
      AccessControl: "LogDeliveryWrite"
      LifecycleConfiguration:
        Rules:
          - Id: "ExpirationRule"
            Status: "Enabled"
            ExpirationInDays: 90

  # S3 Access Log Bucket Policy
  TerraformLogBucketPolicy:
      Type: "AWS::S3::BucketPolicy"
      Properties:
        Bucket:
          Ref: TerraformLogBucket
        PolicyDocument:
          Statement:
            # Only MFA-ed users can delete
            - Action: "s3:Delete*"
              Effect: "Deny"
              Principal: "*"
              Resource:
                Fn::Sub: "arn:aws:s3:::${TerraformLogBucket}/*"
              Condition:
                BoolIfExists:
                  aws:MultiFactorAuthPresent: false

  # CloudTrail Logs Bucket
  TerraformCloudTrailBucket:
    DeletionPolicy: Retain
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName:
        Fn::Sub: "${AWS::StackName}-terraform-cloudtrail"
      LifecycleConfiguration:
        Rules:
          - Id: "ExpirationRule"
            Status: "Enabled"
            ExpirationInDays: 730

  # CloudTrail Logs Bucket Policy
  TerraformCloudTrailBucketPolicy:
    Type: "AWS::S3::BucketPolicy"
    Properties:
      Bucket:
        Ref: TerraformCloudTrailBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "cloudtrail.amazonaws.com"
            Action: "s3:GetBucketAcl"
            Resource:
              Fn::Sub: "arn:aws:s3:::${TerraformCloudTrailBucket}"
          - Effect: "Allow"
            Principal:
              Service: "cloudtrail.amazonaws.com"
            Action: "s3:PutObject"
            Resource:
              Fn::Sub: "arn:aws:s3:::${TerraformCloudTrailBucket}/AWSLogs/${AWS::AccountId}/*"
            Condition:
              StringEquals:
                s3:x-amz-acl: "bucket-owner-full-control"
          # Only MFA-ed users can delete
          - Effect: "Deny"
            Principal: "*"
            Action: "s3:Delete*"
            Resource:
              Fn::Sub: "arn:aws:s3:::${TerraformCloudTrailBucket}/*"
            Condition:
              BoolIfExists:
                aws:MultiFactorAuthPresent: false

  # CloudTrail Audit Logs
  TerraformTrail:
    Type: "AWS::CloudTrail::Trail"
    DependsOn:
      - TerraformCloudTrailBucket
      - TerraformCloudTrailBucketPolicy
    Properties:
      IncludeGlobalServiceEvents: true
      S3BucketName:
        Ref: TerraformCloudTrailBucket
      IsLogging: true
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${AWS::StackName}-terraform"
